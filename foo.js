var P=function(){function P(){}return P.I=function(c,v,f,x,y,b,u,k){var g=c.getContext("webgl2");for(var i in g)g[i[0]+i[6]]=g[i];g.f1=g.uniform1f,g.f2=g.uniform2f,g.mm=g.generateMipmap,g.i1=g.uniform1i;var it=Object.keys(b||{}),p=g.cP(),s=g.cS(35633);g.sS(s,v),g.ce(s),g.aS(p,s),s=g.cS(35632),g.sS(s,f),g.ce(s),g.aS(p,s),g.lo(p),g.ug(p),g.bf(34962,g.cB()),g.eV(0),g.vA(0,2,5120,0,0,0),g.bD(34962,new Int8Array([-3,1,1,-3,1,1]),35044),it.forEach(function(k){var m=new Image;m.onload=function(){g.bx(3553,g.cT()),g.tg(3553,0,6408,512,512,0,6408,5121,m),g.mm(3553)},m.src=b[k].d});var dt=function(){return performance.now()/1e3},tm=dt(),L=function(){var t=tm-dt();g.f1(g.gf(p,"time"),t),g.f2(g.gf(p,"resolution"),x,y),k&&Object.keys(k).forEach(function(v){k[v](g.gf(p,v),g,p,t)}),it.forEach(function(k,i){g.aT(33984+i),g.i1(g.gf(p,k),i)}),g.dr(6,0,3),requestAnimationFrame(L)};L(),u&&u(g,p)},P}(),Synth=function(){function Synth(){}return Synth.G=function(dsp,sr,w,h){var canvas,g=document.createElement("canvas").getContext("webgl2");for(var i in g)g[i[0]+i[6]]=g[i];g.f1=g.uniform1f,g.f2=g.uniform2f;var p=g.cP(),v=g.cS(35633);g.sS(v,this.vs),g.ce(v),g.aS(p,v);var f=g.cS(35632);if(g.sS(f,dsp),g.ce(f),g.aS(p,f),!g.getShaderParameter(f,g.COMPILE_STATUS))throw g.getShaderInfoLog(f).trim().split("\n").forEach(function(l){return console.warn("[shader] "+l)}),new Error("Error while compiling fragment");return g.vr(0,0,w,h),g.lo(p),g.ug(p),g.bf(34962,g.createBuffer()),g.eV(0),g.vA(0,2,5120,0,0,0),g.bD(34962,new Int8Array([-3,1,1,-3,1,1]),35044),g.f1(g.gf(p,"sampleRate"),sr),g.f2(g.gf(p,"resolution"),w,h),function(t,c,_b){var b=_b||new Uint8Array(w*h*4);return g.f1(g.gf(p,"bufferTime"),t/sr),g.f1(g.gf(p,"channel"),c),g.dr(6,0,3),g.rx(0,0,w,h,6408,5121,b),b}},Synth.P=function(gen){var bffs=[],abt=0,aat=0,c=new AudioContext,d=c.createGain(),dc=c.createDynamicsCompressor(),g=c.createGain();g.gain.value=.6,d.connect(dc),dc.connect(g),g.connect(c.destination);var w=128,h=64,S=function(bt,at){var bufferSource=c.createBufferSource();bufferSource.connect(d);var buff=gen(bt,0),ab=c.createBuffer(2,buff.length,c.sampleRate);return ab.getChannelData(0).set(buff),gen(bt,1,buff),ab.getChannelData(1).set(buff),bufferSource.buffer=ab,bufferSource.start(at),bffs.push({data:buff,width:w,height:h,bufferTime:bt,destroy:function(){bufferSource.disconnect(d)}}),{b:bt+buff.length,t:at+ab.duration}},N=function(){var res=S(abt,aat);abt=res.b,aat=res.t};!function L(){bffs=bffs.filter(function(b){return!(b.bufferTime+b.data.length<Math.floor(c.currentTime*c.sampleRate)&&(b.destroy(),1))}),gen&&c.currentTime+8>aat&&N(),setTimeout(L,100)}()},Synth.vs="#version 300 es\n  #ifdef GL_ES\n    precision highp float;\n    precision highp int;\n    precision mediump sampler3D;\n  #endif\n  layout(location = 0) in vec2 pos; \n  out vec4 fragColor;\n      void main() { gl_Position = vec4(2.0*pos-1.0, 0.0, 1.0);\n  }",Synth}(),dsp="#version 300 es\n#ifdef GL_ES\n  precision highp int;\n  precision highp float;\n#endif\nuniform float sampleRate;\nuniform vec2 resolution;\nuniform float channel;\nuniform float bufferTime;\nout vec4 fragColor;\n\nfloat PI = 3.14;\nfloat tau = 6.28;\n\nfloat sub(float wave, float mul, float t){\n  return sin(wave * mul + tau * t);\n}\n\nfloat sine(float x, float t){\n  return sin(tau * t * x);\n}\n\nfloat tri(float x, float t){\n  return abs(1.0 - mod((2.0 * t * x), 2.0)) * 2.0 - 1.0;\n}\n\n\nfloat dsp(float t){\n  float n = 44000.0 / 341.5;\n\n  float bass_osc =\n    0.8 * tri(n/3.0, t)\n  + 0.05 * sine(n*2.0, t)\n  ;\n\n  float lfo = sine(0.18, t);\n  float lfo_mul = sine(0.04, t);\n  float bass_sub =\n    0.8 * sub(bass_osc, 2.0 + ((1.0 + lfo) * (2.0 + (1.0 + lfo_mul) * 12.0) ), t)\n  + 0.7 * sine(n, t)\n  ;\n\n  return 0.4 * bass_sub;\n}\n\nvoid main(){\n \tfloat t = bufferTime + 4.*(gl_FragCoord.y * resolution.x + gl_FragCoord.x) / sampleRate;\n\tvec4 r = vec4(dsp(t),dsp(t+1.0/sampleRate), dsp(t+2.0/sampleRate), dsp(t+3.0/sampleRate)); \n\tfragColor = (r+1.0)/2.0;\n}",generator=Synth.G(dsp,44100,128,64);console.log("starting"),P.I(document.querySelector("#webgl"),"#version 300 es\n    #ifdef GL_ES\n        precision highp float;\n        precision highp int;\n        precision mediump sampler3D;\n    #endif\n    layout(location = 0) in vec2 pos; \n    out vec4 fragColor;\n    void main() { \n        gl_Position = vec4(pos.xy,0.0,1.0);\n    }","#version 300 es\n    #ifdef GL_ES\n        precision highp float;\n        precision highp int;\n        precision mediump sampler3D;\n    #endif\n    uniform float time;\n    uniform vec2 mouse;\n    uniform vec2 resolution;\n    uniform sampler2D iChannel0,iChannel1,iChannel2,iChannel3,iChannel4,fft;out vec4 fragColor;\n    #define RAY_STEPS 100\n    #define SHADOW_STEPS 50\n    #define LIGHT_COLOR vec3(1.,.97,.93)\n    #define AMBIENT_COLOR vec3(.75,.65,.6)\n    #define SPECULAR 0.65\n    #define DIFFUSE 1.0\n    #define AMBIENT 0.35\n    #define BRIGHTNESS 1.5\n    #define GAMMA 1.35\n    #define SATURATION.8\n    #define detail.00004\n    #define t time*.2\n    vec3 v=normalize(vec3(.1,-.15,-1.));const vec3 m=vec3(-1.,.2,0.);float f=0.;vec3 r;mat2 s(float v){return mat2(cos(v),sin(v),-sin(v),cos(v));}vec4 n(vec4 v){return v.rb=abs(v.rb+1.)-abs(v.rb-1.)-v.rb,v=v*2./clamp(dot(v.rgb,v.rgb),.15,1.)-vec4(.5,.5,.8,0.),v.rg*=s(.5),v;}float x(vec3 v){float m=length(v.gb-vec2(.25,0.))-.5,i=length(v.gb-vec2(.25,2.))-.5;return min(max(m,abs(v.r-.3)-.01),max(i,abs(v.r+2.3)-.01));}vec2 i(vec3 v){float i=0.;vec3 f=v;f.b=abs(2.-mod(f.b,4.));vec4 m=vec4(f,1.5);float b=max(0.,.35-abs(v.g-3.35))/.35;\n    #ifdef LESSDETAIL\n    for(int r=0;r<6;r++)m=n(m);float r=max(-f.r-4.,(length(max(vec2(0.),m.gb-2.))-.5)/m.a);\n    #else\n    for(int c=0;c<8;c++)m=n(m);float c=max(-f.r-4.,length(max(vec2(0.),m.gb-3.))/m.a);\n    #endif\n    float s=x(f),d=min(s,c);if(abs(d-s)<.001)i=1.;return vec2(d,i);}vec2 p(vec3 v){v.b=abs(2.-mod(v.b,4.));float m,i=m=0.,f=1000.;for(int r=0;r<15;r++){v=n(vec4(v,0.)).rgb;float s=i;i=length(v);m+=exp(-10./abs(i-s));f=min(f,abs(i-3.));}return vec2(m,f);}vec3 d(float v){vec3 r=vec3(sin(v)*2.,(1.-sin(v*.5))*.5,-cos(v*.25)*30.)*.5;return r;}vec3 w(vec3 v){vec3 m=vec3(0.,f,0.);return normalize(vec3(i(v+m.grr).r-i(v-m.grr).r,i(v+m.rgr).r-i(v-m.rgr).r,i(v+m.rrg).r-i(v-m.rrg).r));}float d(vec3 v,vec3 r){float m=1.,c=2.*f,s=10.;for(int b=0;b<SHADOW_STEPS;b++){if(c<1.&&s>detail){vec3 d=v-c*r;s=i(d).r;m=min(m,max(50.*s/c,0.));c+=max(.01,s);}}return clamp(m,.1,1.);}float i(const vec3 v,const vec3 m){float r=detail*40.,f=0.,c=13.;for(int b=0;b<5;b++){float s=r*float(b*b);vec3 d=m*s+v;float n=i(d).r;f+=-(n-s)*c;c*=.7;}return clamp(1.-5.*f,0.,1.);}vec3 d(in vec3 m,in vec3 f,in vec3 s,in float r){float b=d(m,v),c=i(m,s),e=max(0.,dot(v,-s))*b*DIFFUSE;vec3 n=max(.5,dot(f,-s))*AMBIENT*AMBIENT_COLOR,a=reflect(v,s);float S=pow(max(0.,dot(f,-a))*b,15.)*SPECULAR;vec3 g;vec2 l=p(m);if(r>.5)g=vec3(1.),S=S*S;else{float A=pow(l.r*.11,2.);g=mix(vec3(A,A*A,A*A),vec3(A),.5)+.1;g+=pow(max(0.,1.-l.g),5.)*.3;}g=g*c*(n+e*LIGHT_COLOR)+S*LIGHT_COLOR;if(r>.5){vec3 A=m;A.b=abs(1.-mod(A.b,2.));vec3 R=texture(iChannel4,mod(1.-m.bg-vec2(.4,.2),vec2(1.))).rgb*2.;g+=R*abs(.01-mod(m.g-time*.1,.02))/.01*c;g*=max(0.,1.-pow(length(A.gb-vec2(.25,1.)),2.)*3.5);}else{vec3 A=texture(iChannel4,mod(m.br*2.+vec2(.5),vec2(1.))).rgb;A*=abs(.01-mod(m.r-time*.1*sign(m.r+1.),.02))/.01;g+=pow(l.r,10.)*3e-10*A;g+=pow(max(0.,1.-l.g),4.)*pow(max(0.,1.-abs(1.-mod(m.b+time*2.,4.))),2.)*vec3(1.,.8,.4)*4.*max(0.,.05-abs(m.r+1.))/.05;}return g;}vec3 n(in vec3 m,in vec3 s){float r,c,b=r=0.;vec2 a=vec2(1.,0.);vec3 A,g=vec3(0.);for(int n=0;n<RAY_STEPS;n++){if(a.r>f&&b<30.){A=m+b*s;a=i(A);f=detail*(1.+b*50.);b+=a.r;if(a.r<.015)r+=max(0.,.015-a.r)*exp(-b);}}float n=max(0.,dot(normalize(-s),normalize(v)));vec3 S=vec3(max(0.,-s.g+.6))*AMBIENT_COLOR*.5*max(.4,n);if(a.r<f||b<30.){A=A-abs(a.r-f)*s;vec3 l=w(A);g=d(A,s,l,a.g);g=mix(g,S,1.-exp(-.15*pow(b,1.5)));}else{g=S;vec3 l=(s*3.+vec3(1.3,2.5,1.25))*.3;for(int e=0;e<13;e++)l=abs(l)/dot(l,l)-.9;g+=min(1.,pow(min(5.,length(l)),3.)*.0025);}vec3 l=LIGHT_COLOR*pow(n,25.)*.5;g+=r*(.5+n*.5)*LIGHT_COLOR*.7;g+=l*exp(min(30.,b)*.02);return g;}vec3 e(inout vec3 v){vec3 m=d(t),r=d(t+.7);float b=i(r).r;vec3 a=normalize(r-m);float f=r.r-m.r;f*=min(1.,abs(r.b-m.b))*sign(r.b-m.b)*.7;v.rg*=mat2(cos(f),sin(f),-sin(f),cos(f));f=a.g*1.7;v.gb*=mat2(cos(f),sin(f),-sin(f),cos(f));f=atan(a.r,a.b);v.rb*=mat2(cos(f),sin(f),-sin(f),cos(f));return m;}void main(){r=d(t+.3)+m;vec2 v=gl_FragCoord.rg/resolution.rg*2.-1.;v.g*=resolution.g/resolution.r;vec3 f=normalize(vec3(v*.8,1.)),i=m+e(f),b=n(i,f);b=clamp(b,vec3(0.),vec3(1.));b=pow(b,vec3(GAMMA))*BRIGHTNESS;b=mix(vec3(length(b)),b,SATURATION);fragColor=vec4(b,1.);}\n    ",innerWidth,innerHeight,{},(c,p)=>{document.querySelector("#webgl").addEventListener("click",function(){Synth.P(generator)})});